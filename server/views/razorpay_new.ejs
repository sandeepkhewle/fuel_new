<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Razorpay Payment</title>
</head>

<body>
  <h1>Razorpay Payment Gateway Integration - v3</h1>

  <p>Amount: <%= restdata.amount %> INR</p>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>
    // Inject restdata object from server (potentially HTML-encoded)
    var rawData = '<%- JSON.stringify(restdata) %>';  // Unescaped EJS output to inject restdata safely
    console.log("Raw Data from server:--------", rawData);

    // Replace HTML entities (&#34;) with actual double quotes (")
    var jsonString = rawData.replace(/&#34;/g, '"');
    console.log("Fixed JSON string:---------", jsonString);

    // Parse the corrected string into a valid JSON object
    var restdata = JSON.parse(jsonString);
    console.log("Parsed restdata object:---------", restdata);

    async function payNow(restdata) {

      console.log("restdata----------", restdata);

      var options = {
        "key": restdata.razorpayKeyId, // Razorpay Key ID from backend
        "amount": restdata.amount, // Amount in currency subunits
        "currency": restdata.currency,
        "name": restdata.name, // Merchant name or default
        "description": restdata.description, // Description
        "order_id": restdata.id, // Razorpay order ID
        "callback_url": restdata.callback_url,
        "handler": function (response) {
          console.log(response);
          alert("Payment Succeeded");
        },
        "prefill": {
          "name": restdata.userName, // Pre-fill user's name
          "email": restdata.userEmail, // Pre-fill user's email
          "contact": restdata.userContact // Pre-fill user's contact number
        },
        "notes": {},
        "theme": {
          "color": "#2300a3" // Customize theme color
        }
      };

      // Create Razorpay object
      var razorpayObject = new Razorpay(options);

      // Error handling for payment failure
      razorpayObject.on('payment.failed', function (response) {
        console.log(response);
        alert("Payment Failed");
      });

      // Open Razorpay payment window
      razorpayObject.open();
    }

    // Automatically trigger payment on page load
    window.onload = function () {
      setTimeout(() => {
        console.log("Automatically triggering payNow()");
        payNow(restdata);  // Pass the parsed restdata object to the payNow function
      }, 10);  // Delay for smoother loading
    };
  </script>
</body>

</html>